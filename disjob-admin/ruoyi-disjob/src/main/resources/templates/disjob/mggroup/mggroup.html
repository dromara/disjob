<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
  <th:block th:include="include :: header('分组管理')" />
  <th:block th:include="include :: bootstrap-editable-css" />
</head>
<body class="gray-bg">

  <div class="container-div">
    <div class="row">
      <div class="col-sm-12 search-collapse">
        <form id="sched-group-form">
          <div class="select-list">
            <ul>
              <li>
                <label>分组名称：</label>
                <input type="text" name="group" />
              </li>
              <li>
                <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
              </li>
            </ul>
          </div>
        </form>
      </div>

      <div class="btn-group-sm" id="toolbar" role="group">
        <a class="btn btn-success" onclick="add()" shiro:hasPermission="disjob:mggroup:operate">
          <i class="fa fa-plus"></i> 新增分组
        </a>
        <a class="btn btn-primary single disabled" onclick="token()" shiro:hasPermission="disjob:mggroup:operate">
          <i class="fa fa-edit"></i> 令牌管理
        </a>
      </div>

      <div class="col-sm-12 select-table table-striped">
        <table id="bootstrap-table"></table>
      </div>
    </div>
  </div>

  <th:block th:include="include :: footer" />
  <th:block th:include="include :: bootstrap-table-fixed-columns-js" />
  <th:block th:include="include :: bootstrap-table-editable-js" />
  <script th:inline="javascript">
    var operateFlag = [[${@permission.hasPermi('disjob:mggroup:operate')}]];
    var prefix = ctx + "disjob/mggroup";

    $(function () {
      var options = {
        url: prefix + "/list",
        createUrl: prefix + "/add",
        removeUrl: prefix + "/remove",
        fixedColumns: true,
        fixedNumber: 2,
        onEditableSave: updateOwnUser,
        modalName: "分组",
        columns: [{
          checkbox: true
        },
        {
          field: 'group',
          title: '分组名称',
          formatter: function (value, row, index) {
            return '<a href="javascript:void(0)" onclick="workers(\'' + value + '\')">' + value + '</a>';
          }
        },
        {
          field: 'ownUser',
          title: '负责人',
          editable: {
            type: 'text',
            validate: function(value) {
              if (!value || !value.trim()) {
                return '不能为空';
              }
              if (value.length > 36) {
                return '不能超过36个字符';
              }
            }
          }
        },
        {
          field: 'devUsers',
          title: '开发人员',
          formatter: function (value, row, index) {
            return $.table.tooltip(value, 72, "open");
          }
        },
        {
          field: 'alarmUsers',
          title: '告警人员',
          formatter: function (value, row, index) {
            return $.table.tooltip(value, 72, "open");
          }
        },
        {
          field: 'webHook',
          title: 'Web Hook',
          formatter: function (value, row, index) {
            return $.table.tooltip(value, 72, "open");
          }
        },
        {
          field: 'updatedBy',
          title: '更新人'
        },
        {
          field: 'updatedAt',
          title: '更新时间'
        },
        {
          field: 'createdBy',
          title: '创建人',
          visible: false
        },
        {
          field: 'createdAt',
          title: '创建时间',
          visible: false
        },
        {
          title: '操作',
          align: 'center',
          formatter: function (value, row, index) {
            if (![[${@permission.isPermitted('disjob:mggroup:operate')}]]) {
              return '';
            }
            var actions = [];
            actions.push("<a class='btn btn-danger btn-rounded btn-xs " + operateFlag + "' href='javascript:void(0)' onclick='remove(&quot;" + row.group + "&quot;)'><i class='fa fa-trash'></i> 删除</a> ");
            return '<a tabindex="0" class="btn btn-info btn-rounded btn-xs" role="button" data-container="body" data-placement="left" data-toggle="popover" data-html="true" data-trigger="hover" data-content="' + actions.join('') + '"><i class="fa fa-chevron-circle-right"></i> 操作</a>';
          }
        }]
      };
      $.table.init(options);
    });

    function add() {
      table.set();
      $.modal.open("添加" + table.options.modalName, $.operate.addUrl(), '770', '240');
    }

    function token() {
      table.set();
      var rows = $("#" + table.options.id).bootstrapTable('getSelections');
      if (rows.length !== 1) {
        $.modal.alertWarning("请选择一条记录");
        return;
      }
      var url = prefix + '/token?group=' + rows[0].group;
      $.modal.open("令牌管理", url, '770', '350', null, ['复制', '关闭']);
    }

    function remove(group) {
      table.set();
      $.modal.confirm("确定删除分组'" + group + "'吗？", function() {
        $.operate.post(table.options.removeUrl, { "group": group });
      });
    }

    function workers(group) {
      table.set();
      $.modal.popupRight("Workers", prefix + '/worker?group=' + group);
    }

    function updateOwnUser(field, row, rowIndex, oldValue) {
      var params = { "group": row.group, "ownUser": row[field] };
      $.operate.post(prefix + "/update_own_user", params);
    }
  </script>

</body>
</html>
